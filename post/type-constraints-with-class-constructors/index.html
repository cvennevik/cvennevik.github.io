<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Enforcing advanced type constraints with class constructors in TypeScript - Cecilie Vennevik</title>
<meta name=author content="Cecilie Vennevik"><link rel=alternate href=https://www.cvennevik.no/index.xml type=application/rss+xml title="Cecilie Vennevik"><link rel=stylesheet href=https://www.cvennevik.no/css/bootstrap.min.css><link rel=stylesheet href=https://www.cvennevik.no/css/main.css><link rel=stylesheet href=https://www.cvennevik.no/css/fonts.css></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom top-nav-short"><div class=container-fluid><div class=navbar-header><a class=navbar-brand href=https://www.cvennevik.no/>Cecilie Vennevik</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"></ul></div></div></nav><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Enforcing advanced type constraints with class constructors in TypeScript</h1><span class=post-meta>January 20, 2023</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Frequently, when programming, I am working with data that I expect to follow a set of constraints.</p><ul><li>This parameter must be a string.</li><li>This return value cannot be null.</li><li>This object must have a username property.</li></ul><p>Constraints like these are typically common and easy to express in statically typed languages.</p><p>Sometimes (actually a lot of times) I am working with data that should follow stricter, more complicated constraints.</p><ul><li>This user-submitted application cannot have the <code>approvedTime</code> value set.</li><li>This username must be non-empty and cannot have special characters.</li><li>This <code>from</code> value must be before the <code>to</code> value.</li></ul><p>These constraints can be more tricky to express in a type definition, and I rarely see it attempted. Instead, I see functions either assume the data is valid, or run validation checks on the data that throw an error if it breaks a rule.</p><p>Following the advice of <em>&ldquo;parse, don&rsquo;t validate&rdquo;</em> (see <a href=https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/>the wonderful post by Alexis King</a>), I would rather that the type itself is able to enforce its own constraints. This guarantees and preserves the validity of the data as you pass it on to other functions, and reduces the risk of insufficient <em>and</em> redundant validation checks around your codebase.</p><p>With a few tricks, most constraints you can imagine can be enforced with a type definition. In this case, I&rsquo;ll be showing how to use <strong>classes</strong> to guarantee constraints on TypeScript data that simple <code>type</code> and <code>interface</code> declarations are unable to. (This technique also works in any statically typed language that supports classes.)</p><h2 id=the-technique>The technique</h2><ol><li>Define a class containing the values you want to wrap.</li><li>In the constructor, check for any constraints you are interested in.</li><li>Throw an error if any of the constructor checks fail.</li></ol><p>Key to this technique being widely applicable is that <strong>you are allowed to write class wrappers for single values.</strong> You incur some overhead for having to instantiate each value as a class, and having to access the instance&rsquo;s value to use it, but in return you can enforce any constraint you can imagine in its constructor. Make this tradeoff at your own discretion.</p><p>To illustrate the technique, I&rsquo;ve spun up a few examples showing what you can do with it.</p><h2 id=a-palindrome-type>A palindrome type</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Palindrome</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span> (<span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reversedValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;&#39;</span>).<span style=color:#a6e22e>reverse</span>().<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>value</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>reversedValue</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>value</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34; is not a palindrome`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To ensure the string is a palindrome, we reverse it and check if the reversed string is equal to the original string. If not, we throw an error. Then we save the string to the <code>value</code> field.</p><p>In practice, usage looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>palindrome</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Palindrome</span>(<span style=color:#e6db74>&#39;())(&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>palindrome</span>); <span style=color:#75715e>// Output: Palindrome { value: &#39;())(&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>palindrome</span>.<span style=color:#a6e22e>value</span>); <span style=color:#75715e>// Output: &#39;())(&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invalidPalindrome</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Palindrome</span>(<span style=color:#e6db74>&#39;(())&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// Error: &#34;(())&#34; is not a palindrome
</span></span></span></code></pre></div><p>The <code>Palindrome</code> class guarantees that every instance of <code>Palindrome</code> contains a string that has passed the constructor validation. If you have any functions that <em>must</em> have a palindrome, the <code>Palindrome</code> type is an effective way to enforce it.</p><p>If you would rather not throw an error, but check if the string is a palindrome and handle the invalid case another way, you can create a parse method that wraps the palindrome creation in a <code>try</code> block, and return <code>undefined</code> if it fails:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Palindrome</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>parse</span> (<span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Palindrome</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Palindrome</span>(<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>Palindrome</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#39;())(&#39;</span>)); <span style=color:#75715e>// Output: Palindrome { value: &#39;())(&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>Palindrome</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#39;(())&#39;</span>)); <span style=color:#75715e>// Output: undefined
</span></span></span></code></pre></div><h2 id=a-sorted-array>A sorted array</h2><p>A constructor does not have to throw errors to ensure a constraint. It can also do the work to transform data to a desired form, then pin it in place.</p><p>For instance, you can create a <code>SortedArray</code> class that sorts your array for you:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SortedArray</span>&lt;<span style=color:#f92672>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Mark as ReadonlyArray to ensure contents stay sorted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>contents</span>: <span style=color:#66d9ef>ReadonlyArray</span>&lt;<span style=color:#f92672>T</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span> (<span style=color:#a6e22e>contents</span>: <span style=color:#66d9ef>T</span>[]) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Copy the array so we do not reorder the original array,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// and prevent changes to the original array from affecting our sorted array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>copy</span> <span style=color:#f92672>=</span> [...<span style=color:#a6e22e>contents</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>copy</span>.<span style=color:#a6e22e>sort</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>contents</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>copy</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sortedArray</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SortedArray</span>([<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>sortedArray</span>.<span style=color:#a6e22e>contents</span>); <span style=color:#75715e>// Output: [ 0, 2, 3, 4, 4, 5 ]
</span></span></span></code></pre></div><p>This may be useful if you are working with algorithms that expect a sorted array, like search.</p><h2 id=a-range-with-an-estimate>A range with an estimate</h2><p>Classes can, of course, also enforce constraints for multiple values. While I was experimenting with a game-playing traditional AI, my search algorithm used an <code>EstimateRange</code> data type to describe the minimum, estimate, and maximum value of a given game state. To make sense, the minimum cannot be greater than the maximum, and the estimate must be between them.</p><p>Here is how this can be enforced in TypeScript:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EstimateRange</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>minimum</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>estimate</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>maximum</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span> (<span style=color:#a6e22e>minimum</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>estimate</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>maximum</span>: <span style=color:#66d9ef>number</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>minimum</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>maximum</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Minimum (</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>minimum</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) is greater than maximum (</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>maximum</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>estimate</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>maximum</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Estimate (</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>estimate</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) is greater than maximum (</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>maximum</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>estimate</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>minimum</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Estimate (</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>estimate</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) is less than minimum (</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>minimum</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>minimum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>minimum</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>estimate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>estimate</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>maximum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>maximum</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>EstimateRange</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>10</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// Output: EstimateRange { minimum: 0, estimate: 7, maximum: 10 }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>EstimateRange</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// Error: Minimum (10) is greater than maximum (0)
</span></span></span></code></pre></div><p>The point I am trying to make with the variety of examples is that there is a lot you can do with classes. The constraints you can enforce are mostly limited by your imagination.</p><h2 id=a-warning>A warning</h2><p>This trick comes with a caveat: <strong>If possible, you are better off enforcing constraints with simpler alternatives.</strong> I prefer using more concise type system features when I can. For TypeScript, you can browse the <a href=https://www.typescriptlang.org/docs/handbook/2/everyday-types.html>Everyday Types</a>, <a href=https://www.typescriptlang.org/docs/handbook/2/objects.html>Object Types</a> and <a href=https://www.typescriptlang.org/docs/handbook/2/types-from-types.html>Creating Types from Types</a> pages of the TypeScript handbook for inspiration.</p><p>When simpler alternatives for type checks are insufficient, class constructor validation is a powerful alternative to fall back on.</p></article></div></div></div><footer><div class=footer-links><a rel=me href=https://hachyderm.io/@cvennevik title=Mastodon>Mastodon</a>
<a href=https://twitter.com/cvennevik title=Twitter>Twitter (unused)</a>
<a href=/index.xml title=RSS>RSS</a></div><p class=theme-by>Theme based on <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a>, adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></footer></body></html>